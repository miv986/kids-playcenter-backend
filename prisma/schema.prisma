generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model RefreshToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  userId    Int
  createdAt DateTime @default(now()) @db.Timestamptz
  expiresAt DateTime @db.Timestamptz
  user      User     @relation(fields: [userId], references: [id])
}

model User {
  id                       Int              @id @default(autoincrement())
  name                     String
  surname                  String
  email                    String?          @unique
  phone_number             String?
  role                     Role             @default(USER)
  password                 String?
  createdAt                DateTime         @default(now()) @db.Timestamptz
  updatedAt                DateTime         @updatedAt @db.Timestamptz
  emailVerifyToken         String?
  isEmailVerified          Boolean          @default(false)
  passwordResetToken       String?
  passwordResetExpires     DateTime?        @db.Timestamptz
  allergies                String?
  dateOfBirth              DateTime?        @db.Timestamptz
  emergency_contact_name_1 String?
  emergency_contact_name_2 String?
  medicalNotes             String?
  notes                    String?
  emergency_phone_1        String?
  emergency_phone_2        String?
  tutorId                  Int?
  adminNotesCreated        ChildNote[]      @relation("AdminNotes")
  childNotesReceived       ChildNote[]      @relation("ChildNotes")
  bookings                 DaycareBooking[]
  refreshTokens            RefreshToken[]
  tutor                    User?            @relation("TutorChildren", fields: [tutorId], references: [id])
  children                 User[]           @relation("TutorChildren")
  daycareBookings          DaycareBooking[] @relation("DaycareBookingChildren")
}

model DaycareBooking {
  id               Int              @id @default(autoincrement())
  comments         String?
  status           Status           @default(PENDING)
  startTime        DateTime         @db.Timestamptz
  endTime          DateTime         @db.Timestamptz
  createdAt        DateTime         @default(now()) @db.Timestamptz
  updatedAt        DateTime         @updatedAt @db.Timestamptz
  userId           Int?
  attendanceStatus AttendanceStatus @default(PENDING)
  user             User?            @relation(fields: [userId], references: [id])
  children         User[]           @relation("DaycareBookingChildren")
  slots            DaycareSlot[]    @relation("DaycareSlotBookings")
  
  // Campos para reservas manuales (sin usuario registrado)
  isManual                 Boolean  @default(false)
  manualClientName         String?
  manualNumberOfChildren   Int?
  manualChildName          String?
  manualParent1Name        String?
  manualParent1Phone       String?
  manualParent2Name        String?
  manualParent2Phone       String?

  @@index([userId, status])
  @@index([startTime, endTime])
  @@index([status])
  @@index([createdAt])
  @@index([isManual])
}

model DaycareSlot {
  id             Int              @id @default(autoincrement())
  date           DateTime         @db.Timestamptz
  capacity       Int
  availableSpots Int
  status         Status           @default(OPEN)
  createdAt      DateTime         @default(now()) @db.Timestamptz
  updatedAt      DateTime         @updatedAt @db.Timestamptz
  hour           Int
  closeHour      DateTime         @db.Timestamptz
  openHour       DateTime         @db.Timestamptz
  bookings       DaycareBooking[] @relation("DaycareSlotBookings")

  @@index([date, hour])
  @@index([date, status])
  @@index([openHour, closeHour])
  @@index([status])
}

model BirthdayBooking {
  id             Int           @id @default(autoincrement())
  guest          String
  number_of_kids Int
  contact_number String
  comments       String?
  packageType    Package?
  status         Status        @default(PENDING)
  slotId         Int?          @unique
  createdAt      DateTime      @default(now()) @db.Timestamptz
  updatedAt      DateTime      @updatedAt @db.Timestamptz
  guestEmail     String
  slot           BirthdaySlot? @relation(fields: [slotId], references: [id], onDelete: Cascade)

  // Campos para guardar la fecha original del slot cuando se cancela (hist√≥rico)
  originalSlotDate      DateTime? @db.Timestamptz
  originalSlotStartTime DateTime? @db.Timestamptz
  originalSlotEndTime   DateTime? @db.Timestamptz

  @@index([status])
  @@index([guestEmail])
  @@index([createdAt])
}

model BirthdaySlot {
  id        Int              @id @default(autoincrement())
  date      DateTime         @db.Timestamptz
  startTime DateTime         @db.Timestamptz
  endTime   DateTime         @db.Timestamptz
  status    Status           @default(CLOSED)
  createdAt DateTime         @default(now()) @db.Timestamptz
  updatedAt DateTime         @updatedAt @db.Timestamptz
  booking   BirthdayBooking?

  @@index([date])
  @@index([startTime, endTime])
  @@index([status])
}

model MeetingSlot {
  id             Int              @id @default(autoincrement())
  date           DateTime         @db.Timestamptz
  startTime      DateTime         @db.Timestamptz
  endTime        DateTime         @db.Timestamptz
  capacity       Int
  availableSpots Int
  status         Status           @default(OPEN)
  createdAt      DateTime         @default(now()) @db.Timestamptz
  updatedAt      DateTime         @updatedAt @db.Timestamptz
  bookings       MeetingBooking[]

  @@index([date])
  @@index([startTime, endTime])
  @@index([status])
}

model MeetingBooking {
  id        Int          @id @default(autoincrement())
  email     String
  name      String
  phone     String?
  comments  String?
  status    Status       @default(PENDING)
  slotId    Int
  createdAt DateTime     @default(now()) @db.Timestamptz
  updatedAt DateTime     @updatedAt @db.Timestamptz
  slot      MeetingSlot  @relation(fields: [slotId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([name])
  @@index([email])
  @@index([createdAt])
  @@index([slotId])
}

model BirthdayPackage {
  id             Int      @id @default(autoincrement())
  nameEs         String
  nameCa         String
  type           Package  @unique  
  durationEs     String?
  durationCa     String?
  price          String?
  priceValue     Int?
  isPopular      Boolean  @default(false)
  isActive       Boolean  @default(true)
  showBookButton Boolean  @default(true)
  createdAt      DateTime @default(now()) @db.Timestamptz
  updatedAt      DateTime @updatedAt @db.Timestamptz
  featuresEs     String[]
  featuresVa     String[] 
  perChildTextEs String?
  perChildTextVa String?
}

model ChildNote {
  id        Int      @id @default(autoincrement())
  childId   Int
  adminId   Int
  content   String
  images    String[]
  noteDate  DateTime @default(now()) @db.Timestamptz
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now()) @db.Timestamptz
  updatedAt DateTime @updatedAt @db.Timestamptz
  admin     User     @relation("AdminNotes", fields: [adminId], references: [id])
  child     User     @relation("ChildNotes", fields: [childId], references: [id], onDelete: Cascade)
}

enum Role {
  USER
  ADMIN
  CHILD
}

enum Status {
  PENDING
  CANCELLED
  CONFIRMED
  CLOSED
  OPEN
}

enum AttendanceStatus {
  PENDING
  ATTENDED
  NOT_ATTENDED
}

enum Package {
  ALEGRIA
  FIESTA
  ESPECIAL
  OTRO
}
